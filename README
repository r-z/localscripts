WARNING: messy code. Use at your own risk.
Licence is GPL unless stated otherwise.
