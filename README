WARNING: messy code. Use at your own risk.
Licence is GNU GPL unless stated otherwise.
